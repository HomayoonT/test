name: Selenium VNC Debug

on:
  push:
    branches:
      - main

jobs:
  selenium_vnc:
    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y xvfb x11vnc fluxbox xfce4 wget curl jq default-jre unzip

          wget https://selenium-release.storage.googleapis.com/3.141/selenium-server-standalone-3.141.59.jar

      - name: Set up X, VNC, Selenium, and ngrok
        run: |
          # Start virtual display
          Xvfb :1 -screen 0 1024x768x16 &
          export DISPLAY=:1

          # Wait for Xvfb to be ready
          for i in {1..10}; do
            if xdpyinfo -display :1 > /dev/null 2>&1; then
              echo "âœ… Xvfb is ready."
              break
            else
              echo "â³ Waiting for Xvfb to start..."
              sleep 1
            fi
          done

          # Start window manager
          fluxbox &

          # Set VNC password
          x11vnc -storepasswd secret /tmp/passwd

          # Start VNC server
          x11vnc -forever -rfbauth /tmp/passwd -display :1 -shared -nopw -bg

          # Start Selenium server
          java -jar selenium-server-standalone-3.141.59.jar -port 4444 &

          # Set up ngrok
          wget https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-amd64.zip
          unzip ngrok-stable-linux-amd64.zip
          ./ngrok authtoken 1QzNVolV9VvSiUE7AlMnKlFkg1J_3VBimpCJrC4JHXLNwVvwd
          ./ngrok tcp 5900 > /dev/null &

          # Wait for ngrok to spin up
          sleep 5

          # Print ngrok URL
          echo "ðŸ”— VNC Public URL:"
          curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url'

          # Keep container alive
          tail -f /dev/null
