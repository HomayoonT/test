name: Selenium VNC Debug with Chrome

on:
  push:
    branches:
      - main

jobs:
  selenium_vnc_chrome:
    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y xvfb x11vnc fluxbox wget curl jq default-jre unzip gnupg2

          # Install Google Chrome
          wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
          sudo apt update
          sudo apt install -y google-chrome-stable

          # Install ChromeDriver (auto-matching version)
          CHROME_VERSION=$(google-chrome --version | grep -oP '\d+\.\d+\.\d+')
          CHROMEDRIVER_VERSION=$(curl -s "https://chromedriver.storage.googleapis.com/LATEST_RELEASE_$CHROME_VERSION")
          wget -O chromedriver.zip "https://chromedriver.storage.googleapis.com/$CHROMEDRIVER_VERSION/chromedriver_linux64.zip"
          unzip chromedriver.zip
          sudo mv chromedriver /usr/local/bin/
          chmod +x /usr/local/bin/chromedriver

          # Download Selenium Standalone Server
          wget https://selenium-release.storage.googleapis.com/3.141/selenium-server-standalone-3.141.59.jar

      - name: Set up virtual desktop and VNC
        run: |
          Xvfb :1 -screen 0 1280x800x16 &
          export DISPLAY=:1
          echo "export DISPLAY=:1" >> $GITHUB_ENV
          sleep 2

          fluxbox &
          sleep 1

          x11vnc -storepasswd secret /tmp/passwd
          x11vnc -forever -rfbauth /tmp/passwd -display :1 -shared -bg
          sleep 1

          java -jar selenium-server-standalone-3.141.59.jar -port 4444 &
          sleep 3

      - name: Launch Chrome in GUI
        run: |
          export DISPLAY=:1
          google-chrome-stable --no-sandbox --disable-dev-shm-usage --start-maximized &

      - name: Install and start ngrok (v3)
        run: |
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt update && sudo apt install -y ngrok

          ngrok config add-authtoken 1QzNVolV9VvSiUE7AlMnKlFkg1J_3VBimpCJrC4JHXLNwVvwd
          ngrok tcp 5900 --log=stdout > ngrok.log &
          sleep 3

      - name: Get ngrok public URL
        run: |
          echo "‚è≥ Waiting for ngrok tunnel..."
          for i in {1..15}; do
            NGROK_URL=$(curl -s http://127.0.0.1:4040/api/tunnels | jq -r '.tunnels[0].public_url // empty')
            if [[ -n "$NGROK_URL" ]]; then
              echo "üîó VNC Public URL: $NGROK_URL"
              break
            else
              echo "‚åõ Still waiting..."
              sleep 2
            fi
          done

          if [[ -z "$NGROK_URL" ]]; then
            echo "‚ùå ngrok tunnel failed. ngrok logs:"
            cat ngrok.log
          fi

      - name: Keep session alive
        run: |
          echo "üîß Session ready. Use VNC to view the Chrome browser!"
          tail -f /dev/null
