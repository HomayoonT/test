name: Selenium VNC Test

on: 
  push:
    branches:
      - main

jobs:
  selenium_vnc:
    runs-on: ubuntu-latest
    steps:
      # Step 1: Checkout the repository (if you have any code)
      - name: Checkout code
        uses: actions/checkout@v2

      # Step 2: Set up the environment
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y xfce4 xfce4-goodies x11vnc fluxbox curl jq
          curl -O https://github.com/SeleniumHQ/selenium/releases/download/selenium-3.141.59/selenium-server-standalone-3.141.59.jar
          
      # Step 3: Start VNC server and Selenium
      - name: Start VNC and Selenium server
        run: |
          # Set up VNC password and start the server
          x11vnc -storepasswd secret /tmp/passwd
          x11vnc -forever -usepw -create -display :1 &
          
          # Start the X server (the graphical environment)
          export DISPLAY=:1
          fluxbox &
          
          # Start the Selenium server in headless mode (it runs indefinitely)
          java -jar selenium-server-standalone-3.141.59.jar -port 4444 &
          
          # Run a simple infinite loop (this keeps the job alive for testing)
          while true; do sleep 1000; done

      # Step 4: Set up ngrok to expose the VNC server
      - name: Set up ngrok for VNC
        run: |
          curl -s https://ngrok.com/download | tar xz
          ./ngrok authtoken 1QzNVolV9VvSiUE7AlMnKlFkg1J_3VBimpCJrC4JHXLNwVvwd
          ./ngrok tcp 5900 &
          
      # Step 5: Output ngrok URL for VNC connection
      - name: Get ngrok URL
        run: |
          ngrok_url=$(curl -s localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')
          echo "VNC is accessible at: $ngrok_url"
          echo "VNC_URL=$ngrok_url" >> $GITHUB_ENV
          
      # Step 6: Display ngrok URL to allow VNC connection
      - name: Display ngrok URL for VNC
        run: |
          echo "Connect to the VNC session using the following URL:"
          echo "${{ env.VNC_URL }}"
