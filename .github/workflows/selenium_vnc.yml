name: Selenium VNC Debug

on:
  push:
    branches:
      - main

jobs:
  selenium_vnc:
    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y xvfb x11vnc fluxbox xfce4 wget curl jq default-jre

          # Download Selenium JAR (fixed link)
          wget https://selenium-release.storage.googleapis.com/3.141/selenium-server-standalone-3.141.59.jar

      - name: Set up X, VNC, and Selenium
        run: |
          # Start virtual framebuffer (fake display)
          Xvfb :1 -screen 0 1024x768x16 &
          export DISPLAY=:1

          # Start lightweight window manager
          fluxbox &

          # Set up VNC password
          x11vnc -storepasswd secret /tmp/passwd

          # Start VNC server explicitly using password file
          x11vnc -forever -rfbauth /tmp/passwd -display :1 -shared -nopw -bg

          # Start Selenium server
          java -jar selenium-server-standalone-3.141.59.jar -port 4444 &

          # Keep the job alive for debugging
          while true; do sleep 1000; done

      - name: Set up ngrok for VNC
        run: |
          wget https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-amd64.zip
          unzip ngrok-stable-linux-amd64.zip
          ./ngrok authtoken 1QzNVolV9VvSiUE7AlMnKlFkg1J_3VBimpCJrC4JHXLNwVvwd
          ./ngrok tcp 5900 > /dev/null &

      - name: Get ngrok URL
        run: |
          sleep 5
          curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url'
